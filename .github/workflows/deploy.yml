name: Deploy

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Required for OIDC
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: us-east-2
      ECR_REPOSITORY: 448049834146.dkr.ecr.us-east-2.amazonaws.com/terminal
      ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
      ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
      ECS_TASK_DEFINITION: ${{ secrets.ECS_TASK_DEFINITION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: ${{ secrets.AWS_ACCOUNT_ID }}

      - name: Generate immutable tag
        id: tag
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
          IMAGE_TAG="${{ env.ECR_REPOSITORY }}:${COMMIT_SHA}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
          echo "Generated immutable tag: ${IMAGE_TAG}"

      - name: Build Docker image
        run: |
          echo "Building Docker image for x86_64..."
          echo "Target image: ${{ env.IMAGE_TAG }}"
          docker build -t terminal .

      - name: Tag Docker image
        run: |
          echo "Tagging image: ${{ env.IMAGE_TAG }}"
          docker tag terminal:latest ${{ env.IMAGE_TAG }}

      - name: Push image to ECR
        run: |
          echo "Pushing image to ECR: ${{ env.IMAGE_TAG }}"
          docker push ${{ env.IMAGE_TAG }}

      - name: Verify image push
        run: |
          echo "Verifying image was pushed: ${{ env.IMAGE_TAG }}"
          if aws ecr describe-images --repository-name terminal --image-ids imageTag=${{ env.COMMIT_SHA }} --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "‚úÖ Image successfully available in ECR: ${{ env.IMAGE_TAG }}"
          else
            echo "‚ùå Image not found in ECR"
            exit 1
          fi

      - name: Download current task definition
        run: |
          echo "Downloading current task definition for: ${{ env.ECS_TASK_DEFINITION }}"
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --query taskDefinition \
            --region ${{ env.AWS_REGION }} > task-definition.json

          echo "Current task definition downloaded"

      - name: Update task definition with new image
        id: task-def
        run: |
          echo "Updating task definition with new image: ${{ env.IMAGE_TAG }}"

          # Update the image URI in the task definition
          jq --arg IMAGE_URI "${{ env.IMAGE_TAG }}" \
             '.containerDefinitions[0].image = $IMAGE_URI' \
             task-definition.json > updated-task-definition.json

          # Remove fields that shouldn't be included in registration
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' \
             updated-task-definition.json > final-task-definition.json

          echo "Task definition updated with new image"
          cat final-task-definition.json

      - name: Register new task definition
        id: register-task-def
        run: |
          echo "Registering new task definition..."

          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://final-task-definition.json \
            --region ${{ env.AWS_REGION }} \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          if [ -z "$TASK_DEF_ARN" ]; then
            echo "Failed to register task definition"
            exit 1
          fi

          echo "NEW_TASK_DEF_ARN=${TASK_DEF_ARN}" >> $GITHUB_ENV
          echo "Successfully registered new task definition: ${TASK_DEF_ARN}"

      - name: Update ECS service
        run: |
          echo "Updating ECS service: ${{ env.ECS_SERVICE }} in cluster: ${{ env.ECS_CLUSTER }}"

          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ env.NEW_TASK_DEF_ARN }} \
            --region ${{ env.AWS_REGION }}

          echo "ECS service update initiated"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for ECS deployment to complete..."

          # Wait for the service to reach a stable state
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}

          echo "Deployment completed successfully!"

      - name: Verify deployment
        run: |
          echo "Verifying deployment status..."

          # Get the current running task definition
          CURRENT_TASK_DEF=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].taskDefinition' \
            --output text)

          echo "Current running task definition: ${CURRENT_TASK_DEF}"
          echo "Expected task definition: ${{ env.NEW_TASK_DEF_ARN }}"

          if [ "${CURRENT_TASK_DEF}" = "${{ env.NEW_TASK_DEF_ARN }}" ]; then
            echo "‚úÖ Deployment verification successful!"
            echo "üöÄ Successfully deployed image: ${{ env.IMAGE_TAG }}"
          else
            echo "‚ùå Deployment verification failed!"
            echo "Current task definition does not match expected"
            exit 1
          fi
